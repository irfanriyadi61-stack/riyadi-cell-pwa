<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RIYADI CELL – OCR & Generator Struk</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<style>
 body { font-family: Arial; padding: 10px; background: #f5f5f5; }
 .box { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.12); }
 input, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
 button { background:#e63946; color:white; padding:12px 18px; border:0; border-radius:8px; margin-top:10px; cursor:pointer; }
 #preview { width:100%; margin-top:10px; border-radius:10px; display:none; }
 #struk58 { font-family: monospace; white-space: pre; background:white; padding:10px; border-radius:10px; }
</style>
</head>
<body>
<h2><b>RIYADI CELL – OCR, Autofill & Generator Struk</b></h2>

<div class="box">
 <label><b>Pilih Gambar Struk</b></label><br>
 <input type="file" id="imageInput" accept="image/*" />
 <img id="preview" />
</div>

<div class="box">
 <button onclick="runOCR()">Proses OCR</button>
 <pre id="ocrResult"></pre>
</div>

<div class="box">
 <h3>Data Struk (Autofill dari OCR)</h3>
 <label>waktu transaksi</label>
 <input id="waktu" />

 <label>No. referensi</label>
 <input id="no referensi" />

 <label>No.rekening tujuan</label>
 <input id="nomor rekening tujuan" />

 <label>nama penerima</label>
 <input id="nama penerima" />

 <label>No. referensi</label>
 <input id="no referensi" />

  <label>biaya admin</label>
 <input id="5000" />

 <button onclick="generateStruk()">Buat Struk 58mm</button>
</div>

<div class="box">
 <h3>Struk 58mm (Preview)</h3>
 <div id="struk58"></div>
 <button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
const input = document.getElementById('imageInput');
const preview = document.getElementById('preview');

input.addEventListener('change', () => {
 const file = input.files[0];
 if (file) {
   preview.src = URL.createObjectURL(file);
   preview.style.display = "block";
 }
});

async function runOCR() {
  const file = input.files[0];
  if (!file) return alert('Pilih gambar dulu');

  document.getElementById('ocrResult').textContent = "Memproses OCR...";

  // jalankan Tesseract dan ambil hasil + words (untuk confidence jika perlu)
  const res = await Tesseract.recognize(file, 'ind', { logger: m => {} });
  const textRaw = res.data.text || '';
  const words = res.data.words || [];
  document.getElementById('ocrResult').textContent = textRaw;

  // Normalisasi: ubah beberapa karakter umum yang sering salah
  let text = textRaw.replace(/\u00A0/g,' ')   // non-breaking space
                    .replace(/[\t]+/g,' ')
                    .replace(/[O]{1,}/g, 'O')   // optional - keep O
                    .replace(/[^ -~\n]/g, '')   // hapus karakter non-ascii
                    .replace(/\r/g,'\n');

  // Bikin array baris (trim tiap baris)
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length>0);

  // Util: cari baris yang cocok pattern (banyak pola fallback)
  const findLine = (patterns) => {
    for (const p of patterns) {
      for (const l of lines) {
        if (p instanceof RegExp) {
          if (p.test(l)) return l;
        } else {
          if (l.toLowerCase().includes(p.toLowerCase())) return l;
        }
      }
    }
    return '';
  };

  // Cari nominal (beberapa pola)
  const nominalLine = findLine([/Rp\s?[0-9\.\,]+/i, /Jumlah\s*[:\-]?\s*Rp/i, /\bRp\b/]);
  let nominal = '';
  if (nominalLine) {
    const m = nominalLine.match(/Rp\s?([0-9\.,]+)/i) || nominalLine.match(/([0-9\.,]+)\s?Rp/i);
    if (m) nominal = 'Rp ' + m[1].replace(/\.(?=\d{3})/g, '.').replace(/,/g, '.'); // standardize
  } else {
    // fallback: cari angka besar terakhir di teks
    const allNums = text.match(/[0-9]{3,}[0-9\.,]*/g) || [];
    if (allNums.length) nominal = 'Rp ' + allNums[allNums.length-1].replace(/[^0-9]/g,'');
  }

  // Cari waktu / tanggal
  let waktu = findLine([/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}/, /\d{1,2}\s\w+\s\d{4},\s*\d{2}:\d{2}/, /Waktu Transaksi/i]) || '';
  if (waktu) {
    const m = waktu.match(/\d{1,2}\s\w+\s\d{4},\s*\d{2}:\d{2}/) || waktu.match(/\d{2}[-\/]\d{2}[-\/]\d{2,4}\s*\d{2}:\d{2}/);
    if (m) waktu = m[0];
  }

  // Cari no transaksi
  let noTrans = findLine([/No\.?\s*Transaksi/i, /No\s*Trans/i, /Transaction\s*No/i]) || '';
  if (noTrans) {
    const m = noTrans.match(/([0-9]{8,})/);
    if (m) noTrans = m[1];
    else noTrans = noTrans.replace(/[^\d]/g,'');
  } else {
    // fallback cari pola panjang mulai 202[0-9]...
    const m2 = text.match(/20\d{8,}/);
    noTrans = m2 ? m2[0] : '';
  }

  // Cari nomor tujuan (rekening / hp)
  let nomor = findLine([/No\.?\s?Rek/i, /Rek\.?/i, /No\.?\s?Tujuan/i, /08[0-9]{8,12}/]) || '';
  if (nomor) {
    const m = nomor.match(/(08[0-9]{8,12})/) || nomor.match(/([0-9\*]{4,})/);
    nomor = m ? m[0].replace(/\s/g,'') : nomor;
  } else {
    // cari pertama yang mirip rekening/hp
    const m3 = text.match(/08[0-9]{8,12}/) || text.match(/\*{2,}[0-9]{2,4}/);
    nomor = m3 ? m3[0] : '';
  }

  // Cari nama (heuristik: baris setelah kata 'Nama' atau 'Atas Nama' / baris yang mengandung huruf kapital)
  let nama = '';
  const namaLine = findLine(['Atas Nama', 'Nama Penerima', 'Nama', /Atas Nama/i]);
  if (namaLine) {
    const mm = namaLine.match(/Atas Nama[:\s-]*([A-Za-z\s\.]+)/i) || namaLine.match(/Nama[:\s-]*([A-Za-z\s\.]+)/i);
    nama = mm ? mm[1].trim() : '';
  }
  if (!nama) {
    // fallback: cari baris yang tampak seperti nama (lebih dari satu kata, huruf)
    const candidate = lines.find(l => /^[A-Za-z][A-Za-z\s\.]{3,}$/.test(l) && l.split(' ').length<=5 && l.length<40);
    if (candidate) nama = candidate;
  }

  // Tampilkan hasil auto-fill ke input form
  if (nominal) document.getElementById('harga').value = nominal;
  if (nomor) document.getElementById('nomor').value = nomor;
  if (waktu) document.getElementById('waktu').value = waktu;
  if (noTrans) {
    const el = document.getElementById('notrans') || null;
    if (el) el.value = noTrans;
  }
  if (nama) {
    const eln = document.getElementById('nama_penerima') || null;
    if (eln) eln.value = nama;
  }

  // Confidence check (average)
  let avgConf = 0;
  if (words && words.length) {
    avgConf = words.reduce((s,w)=>s+(w.confidence||0),0)/words.length;
  }
  if (avgConf < 70) {
    // beri peringatan tapi tetap isi
    alert('Peringatan: akurasi OCR rendah (confidence ~' + Math.round(avgConf) + '). Mohon periksa hasil autofill dan koreksi jika perlu.');
  }
}


function generateStruk() {
 const p = document.getElementById('produk').value;
 const n = document.getElementById('nomor').value;
 const h = document.getElementById('harga').value;
 const w = document.getElementById('waktu').value;

 const format = `RIYADI CELL\n-----------------------------\nProduk : ${p}\nNomor  : ${n}\nHarga  : ${h}\nWaktu  : ${w}\n-----------------------------\nTerima kasih :)`;

 document.getElementById('struk58').textContent = format;
}

function downloadPDF() {
 const { jsPDF } = window.jspdf || {};
 if (!jsPDF) {
   alert('jsPDF belum di-load');
   return;
 }
 const pdf = new jsPDF({unit:'mm', format:[58,100]});
 pdf.setFont('courier');
 pdf.setFontSize(8);
 pdf.text(document.getElementById('struk58').textContent, 2, 5);
 pdf.save('struk_riyadi.pdf');
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
