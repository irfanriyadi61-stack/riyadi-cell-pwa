<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RIYADI CELL – OCR & Generator Struk</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<style>
 body { font-family: Arial; padding: 10px; background: #f5f5f5; }
 .box { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.12); }
 input, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
 button { background:#e63946; color:white; padding:12px 18px; border:0; border-radius:8px; margin-top:10px; cursor:pointer; }
 #preview { width:100%; margin-top:10px; border-radius:10px; display:none; }
 #struk58 { font-family: monospace; white-space: pre; background:white; padding:10px; border-radius:10px; }
</style>
</head>
<body>
<div style="text-align:center; margin-bottom:10px;"><img id="logoToko" src="logo_riyadi_cell.png" style="width:250px; height:auto; border-radius:10px;" /></div>
<h2><b>RIYADI CELL – OCR, Autofill & Generator Struk</b></h2>

<div class="box">
 <label><b>Pilih Gambar Struk</b></label><br>
 <input type="file" id="imageInput" accept="image/*" />
 <img id="preview" />
</div>

<div class="box">
 <button onclick="runOCR()">Proses OCR</button>
 <pre id="ocrResult"></pre>
</div>

<div class="box">
 <h3>Data Struk (Autofill dari OCR)</h3>
 <label>Waktu Transaksi</label>
 <input id="waktu" />

 <label>No. Transaksi</label>
 <input id="notrans" />

 <label>Bank Tujuan</label>
 <input id="bank" />

 <label>No Rekening Penerima</label>
 <input id="rek_penerima" />

 <label>Nominal Transfer</label>
 <input id="harga" />

 <label>Biaya Admin</label>
 <input id="admin" />

 <label>Nama Penerima</label>
 <input id="nama_penerima" />

 <div class="box">
 <button onclick="generateStruk()">Buat Struk 58mm</button>
 <pre id="struk58"></pre>
 </div>
 
<div class="box">
 <h3>Struk 58mm (Preview)</h3>
 <div id="struk58" style="white-space: pre;"><img id="logoPrint" src="logo_riyadi_cell.png" style="width:60px; display:block; margin:0 auto 5px;" /></div>
 <button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
async function runOCR() {
  const file = document.getElementById('input').files[0];
  if (!file) return alert('Pilih gambar dulu');

    // Ambil Waktu
    let waktu = '';
    if (text.includes('Waktu Transaksi')) {
      const t = text.split('Waktu Transaksi')[1].trim().split(' ');
      if (t.length >= 4) waktu = `${t[0]} ${t[1]} ${t[2]}, ${t[3]}`;
    }
    document.getElementById('waktu').value = waktu;

    // No Transaksi
    let noTrans = '';
    if (text.includes('No. Transaksi')) {
      noTrans = text.split('No. Transaksi')[1].trim().split(' ')[0];
    }
    document.getElementById('notrans').value = noTrans;

    // Bank
    let bank = '';
    if (text.includes('BANK')) {
      bank = text.split('BANK')[1].trim().split(' ')[0];
    }
    document.getElementById('bank').value = bank;

    // Rekening Penerima
    let rek = '';
    if (text.includes('#')) {
      rek = text.split('#')[1].trim().split(' ')[0];
    }
    document.getElementById('rek_penerima').value = rek;

    // Nominal
    let nominalInt = 0;
    if (text.includes('Rp')) {
      const match = text.split('Rp')[1].match(/[\d.]+/);
      if (match) nominalInt = parseInt(match[0].replace(/\./g, ''));
    }
    document.getElementById('harga').value = nominalInt;

    // Admin
    let admin = 0;
    if (nominalInt >= 10000 && nominalInt <= 300000) admin = 5000;
    else if (nominalInt > 300000 && nominalInt <= 600000) admin = 7000;
    else if (nominalInt > 600000 && nominalInt <= 1000000) admin = 10000;
    document.getElementById('admin').value = admin;

    // Nama Penerima
    let penerima = '';
    if (text.includes('Ke ')) {
      let parts = text.split('Ke ')[1].trim();
      let namaClean = parts.replace(/[^A-Za-z ]+/g, '').trim();
      namaClean = namaClean
        .toLowerCase()
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');

      const stopWords = ['transfer','bank','seabank','fast','bi','penerima','via','ke','dari','admin'];
      namaClean = namaClean
        .split(' ')
        .filter(w => !stopWords.includes(w.toLowerCase()))
        .join(' ')
        .trim();
       penerima = namaClean;
    }
    document.getElementById('nama_penerima').value = penerima;

  } catch (error) {
    console.error("OCR gagal:", error);
    alert('Terjadi kesalahan saat memproses OCR');
  }
}

function generateStruk() {
  const w = document.getElementById('waktu')?.value || '';
  const nt = document.getElementById('notrans')?.value || '';
  const b = document.getElementById('bank')?.value || '';
  const r = document.getElementById('rek_penerima')?.value || '';
  const h = document.getElementById('harga')?.value || '0';
  const a = document.getElementById('admin')?.value || '0';
  const n = document.getElementById('nama_penerima')?.value || '';

  const hInt = parseInt(h) || 0;
  const aInt = parseInt(a) || 0;
  const total = hInt + aInt;

  const format = `RIYADI CELL
========= STRUK TRANSFER =========
Waktu        : ${w}
No. Transaksi: ${nt}
----------------------------------
BANK TUJUAN  : ${b}
Rek Penerima : ${r}
Nama Penerima: ${n}
----------------------------------
Nominal      : Rp ${hInt.toLocaleString('id-ID')}
Biaya Admin  : Rp ${aInt.toLocaleString('id-ID')}
Total        : Rp ${total.toLocaleString('id-ID')}
==================================
Terima kasih telah bertransaksi`;

  const strukEl = document.getElementById('struk58');
  if (strukEl) strukEl.textContent = format;
  else console.error('Element dengan id struk58 tidak ditemukan!');
}

function downloadPDF() {
 const { jsPDF } = window.jspdf || {};
 if (!jsPDF) {
   alert('jsPDF belum di-load');
   return;
 }
 const pdf = new jsPDF({unit:'mm', format:[58,100]});
 pdf.setFont('courier');
 pdf.setFontSize(8);
 // Tambah logo ke PDF
  const img = document.getElementById('logoPrint');
  if (img && img.src) {
    try {
      pdf.addImage(img, 'PNG', 20, 2, 18, 18); // posisi tengah
    } catch(e) {}
  }

  pdf.text(document.getElementById('struk58').textContent, 2, 5);
 pdf.save('struk_riyadi.pdf');
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
